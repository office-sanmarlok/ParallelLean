# ParallelLean マルチワークスペース機能要求仕様書

## 概要
このドキュメントでは、ParallelLeanにマルチワークスペース機能を実装するためのユーザーストーリーと、EARS（Easy Approach to Requirements Syntax）形式による受け入れ基準を定義します。

## システム制約
- ユーザーは同時に1つのワークスペースのオーナーにのみなることができる
- ユーザーは無制限の数のワークスペースのメンバーになることができる
- ワークスペースのロールは「オーナー」と「メンバー」の2種類
- メンバーごとに編集権限を設定可能（読み取り専用、フル編集、エリア別制限）
- 無料/有料プランの区別はない
- オーナーのアカウント削除時、所有するワークスペースも削除される

## 実装上の詳細仕様

### 招待コードの仕様
- 入力時はハイフンあり/なし両方を受け付け、大文字小文字を区別しない
- 表示時はハイフン付きUUID形式（例：12345678-90ab-cdef-1234-567890abcdef）
- コピーボタンを提供し、クリック時に「コピーしました」とトースト表示

### ワークスペース名の仕様
- 文字数：1～50文字
- 使用可能文字：日本語、英数字、スペース、ハイフン、アンダースコア
- 同じ名前の重複を許可（UUIDで識別するため）

### エラーハンドリング
- 同時編集：楽観的ロック（Last Write Wins）方式を採用
- 削除確認：「ワークスペース「[名前]」を削除しますか？影響を受けるメンバー: [N]人。この操作は取り消せません。」
- 権限エラー：「この操作を実行する権限がありません」
- ワークスペース消失時：ホーム画面へリダイレクトし「アクセスしようとしたワークスペースは存在しません」と表示

### セッション管理
- メンバー削除時：該当ユーザーの次回API呼び出しで401エラーを返す
- フロントエンド：401受信でホーム画面へ自動リダイレクト

### ホームページ仕様
- ワークスペース一覧の表示項目：
  - ワークスペース名
  - ロール（オーナー/メンバー）
  - 最終アクセス時刻（「3時間前」形式）
- オーナー制限の表示：
  - 既にオーナーの場合、「オーナーとして新規作成」ボタンをdisabled状態
  - ホバー時ツールチップ：「既に1つのワークスペースのオーナーです」

### 初期状態
- ワークスペース作成時：オーナーはフル編集権限、初期ノードなし
- メンバー参加時：全エリア「編集不可」（読み取り専用）、オーナーが明示的に権限付与

## ユーザーストーリーと受け入れ基準

### 1. ワークスペース管理

#### US-1.1: ワークスペース作成
**As a** 登録ユーザー  
**I want to** 新しいワークスペースを作成する  
**So that** 独立したプロジェクト環境を構築できる

**受け入れ基準:**
- WHEN ユーザーがワークスペース作成を要求する、システムは一意の名前とUUIDを持つ新しいワークスペースを作成しなければならない
- システムは作成したワークスペースの所有者として要求したユーザーを設定しなければならない
- ワークスペース名は1〜50文字で、日本語、英数字、スペース、ハイフン、アンダースコアのみ使用可能でなければならない
- ワークスペース名の重複は許可される（UUIDで一意に識別されるため）
- IF ユーザーが既に1つのワークスペースのオーナーである、THEN システムは新しいワークスペースの作成を拒否し、エラーメッセージを表示しなければならない
- システムは作成されたワークスペースのUUIDを招待コードとして表示しなければならない

#### US-1.2: ワークスペース設定変更
**As a** ワークスペースオーナー  
**I want to** ワークスペースの名前や設定を変更する  
**So that** ワークスペースを適切に管理できる

**受け入れ基準:**
- WHEN オーナーがワークスペース設定の変更を要求する、システムは変更を保存しなければならない
- IF ユーザーがメンバーである、THEN システムは設定変更を拒否しなければならない
- システムは変更履歴を保持しなければならない
- ワークスペースのUUID（招待コード）は変更不可能でなければならない

#### US-1.3: ワークスペース削除
**As a** ワークスペースオーナー  
**I want to** ワークスペースを削除する  
**So that** 不要なワークスペースを整理できる

**受け入れ基準:**
- WHEN オーナーがワークスペース削除を要求する AND 削除確認を行う、システムは以下を即座に削除しなければならない：
  - ワークスペースの設定情報
  - 全てのメンバーシップ情報
  - ワークスペースに属する全てのノード
  - ワークスペースに属する全てのエッジ
  - ワークスペースに属する全てのドキュメント
- IF ユーザーがオーナーでない、THEN システムは削除を拒否しなければならない
- WHEN ワークスペースに他のアクティブメンバーが存在する、システムは「ワークスペース「[名前]」を削除しますか？影響を受けるメンバー: [N]人。この操作は取り消せません。」という確認ダイアログを表示しなければならない

### 2. メンバー管理と招待

#### US-2.1: ワークスペースコード共有
**As a** ワークスペースオーナー  
**I want to** ワークスペースコード（UUID）を共有する  
**So that** 他のユーザーを招待できる

**受け入れ基準:**
- システムはワークスペースのUUIDを招待コードとして常に表示可能にしなければならない
- システムは招待コードをハイフン付きUUID形式（例：12345678-90ab-cdef-1234-567890abcdef）で表示し、コピーボタンを提供しなければならない
- 招待コードには有効期限を設定してはならない
- オーナーは招待コードをいつでも確認できなければならない

#### US-2.2: ワークスペース参加
**As a** 登録ユーザー  
**I want to** 招待コードを使ってワークスペースに参加する  
**So that** チームのワークスペースで作業できる

**受け入れ基準:**
- WHEN ユーザーが有効な招待コード（UUID）を入力する、システムはワークスペース参加確認画面を表示しなければならない
- WHEN ユーザーが参加を確認する、システムはユーザーをメンバーロールでワークスペースに追加しなければならない
- IF 招待コードが無効である、THEN システムはエラーメッセージを表示しなければならない
- IF ユーザーが既にそのワークスペースのメンバーである、THEN システムはエラーメッセージを表示しなければならない
- システムは新規メンバーにデフォルトで全エリア「編集不可」（読み取り専用）権限を設定しなければならない

#### US-2.3: メンバー削除
**As a** ワークスペースオーナー  
**I want to** メンバーをワークスペースから削除する  
**So that** アクセス権を適切に管理できる

**受け入れ基準:**
- WHEN オーナーがメンバーの削除を要求する、システムは対象メンバーのワークスペースメンバーシップ情報のみを削除しなければならない
- IF 対象がワークスペースオーナーである、THEN システムは削除を拒否しなければならない
- WHEN メンバーが削除される、システムはワークスペース内の全てのノード、エッジ、ドキュメントを保持しなければならない（ノードに所有者の概念はない）
- 削除されたメンバーのアクセス権は即座に無効化されなければならない

#### US-2.4: メンバー権限管理
**As a** ワークスペースオーナー  
**I want to** メンバーの編集権限を設定する  
**So that** 適切なアクセスコントロールができる

**受け入れ基準:**
- WHEN オーナーがメンバーの権限を変更する、システムは以下のいずれかの権限を設定できなければならない：
  - 読み取り専用
  - フル編集可能
  - エリア別編集制限
- IF エリア別編集制限を選択する、THEN システムは各エリア（KnowledgeBase、IdeaStock、Build、Measure、Learn）ごとに編集権限（ノードの作成・削除・内容編集）の可否を設定できなければならない
- 権限変更は即座に反映されなければならない
- IF ユーザーがメンバーである、THEN システムは他のメンバーの権限変更を拒否しなければならない

### 3. ワークスペースアクセスと切り替え

#### US-3.0: ホームページの操作
**As a** ログイン中のユーザー  
**I want to** ホームページでワークスペースを管理する  
**So that** ワークスペースの作成、参加、切り替えができる

**受け入れ基準:**
- WHEN ユーザーがホームページ（/）にアクセスする、システムはユーザーが参加しているワークスペース一覧を表示しなければならない
- IF ユーザーがワークスペースに参加していない、THEN システムは「オーナーとして新規作成」と「メンバーとして参加」ボタンを表示しなければならない
- IF ユーザーが既に1つのワークスペースのオーナーである、THEN システムは「オーナーとして新規作成」ボタンを無効化し、ホバー時に「既に1つのワークスペースのオーナーです」とツールチップを表示しなければならない

#### US-3.1: ワークスペース一覧表示
**As a** 登録ユーザー  
**I want to** 自分が参加しているワークスペースの一覧を見る  
**So that** アクセス可能なワークスペースを把握できる

**受け入れ基準:**
- WHEN ユーザーがログインする、システムはユーザーが参加している全てのワークスペースを一覧表示しなければならない
- システムは各ワークスペースに対してユーザーのロール（オーナー/メンバー）を表示しなければならない
- WHILE ワークスペース一覧を表示している、システムは最後にアクセスしたワークスペースを識別可能にしなければならない
- システムはワークスペースを最終アクセス日時でソートして表示し、相対時間形式（例：「3時間前」）で表示しなければならない

#### US-3.2: ワークスペース切り替え
**As a** 複数のワークスペースに参加しているユーザー  
**I want to** ワークスペースを切り替える  
**So that** 異なるプロジェクトで作業できる

**受け入れ基準:**
- WHEN ユーザーが別のワークスペースを選択する、システムは選択されたワークスペースのコンテキストに切り替えなければならない
- システムは現在のワークスペースを視覚的に識別可能にしなければならない
- WHEN ワークスペースを切り替える、システムは前のワークスペースの作業状態を保存しなければならない
- システムはワークスペース切り替えを3秒以内に完了しなければならない

#### US-3.3: 招待コード入力画面
**As a** 登録ユーザー  
**I want to** 招待コードを入力する画面にアクセスする  
**So that** 新しいワークスペースに参加できる

**受け入れ基準:**
- システムはワークスペース一覧画面から招待コード入力画面へのリンクを提供しなければならない
- 招待コード入力フィールドはハイフンあり/なし両方のUUID形式を受け付け、大文字小文字を区別せずに検証しなければならない
- WHEN 有効なコードが入力される、システムはワークスペース名とオーナー名を表示して参加確認を求めなければならない

### 4. データ分離とセキュリティ

#### US-4.1: データアクセス制御
**As a** ワークスペースメンバー  
**I want to** 所属するワークスペースのデータのみにアクセスする  
**So that** データのセキュリティが保たれる

**受け入れ基準:**
- システムはユーザーが所属するワークスペースのデータのみを表示しなければならない
- IF ユーザーが特定のワークスペースに所属していない、THEN システムはそのワークスペースのデータへのアクセスを拒否しなければならない
- WHEN ユーザーがワークスペースから削除される、システムは即座にそのワークスペースのデータへのアクセスを無効化しなければならない
- システムはユーザーが所属しないワークスペースへのアクセス試行を検出し、403エラーを返さなければならない

#### US-4.2: 権限に基づく操作制限
**As a** ワークスペースメンバー  
**I want to** 自分の権限に応じた操作のみを実行する  
**So that** ワークスペースの整合性が保たれる

**受け入れ基準:**
- WHERE ユーザーの権限が「読み取り専用」である、システムはデータの閲覧のみを許可し、作成・編集・削除を拒否して「この操作を実行する権限がありません」というエラーメッセージを表示しなければならない
- WHERE ユーザーの権限が「フル編集可能」である、システムは全エリアでのデータの作成・編集・削除を許可しなければならない
- WHERE ユーザーの権限が「エリア別編集制限」である、システムは許可されたエリアでのみ編集を許可しなければならない
- WHERE ユーザーのロールがメンバーである、システムはワークスペース設定の変更とメンバー管理を拒否しなければならない
- WHERE ユーザーのロールがオーナーである、システムは全ての操作を許可しなければならない

#### US-4.3: クロスワークスペース保護
**As a** システム管理者  
**I want to** ワークスペース間でデータが漏洩しないことを保証する  
**So that** マルチテナントのセキュリティが確保される

**受け入れ基準:**
- システムは全てのデータベースクエリにワークスペースIDフィルタを自動的に適用しなければならない
- IF APIリクエストが異なるワークスペースのリソースにアクセスしようとする、THEN システムは403エラーを返さなければならない
- システムはワークスペース間でのデータ参照を防ぐためのデータベース制約を実装しなければならない
- WHILE システムがバックグラウンドジョブを実行する、各ジョブは単一のワークスペースコンテキストで実行されなければならない

#### US-4.4: オーナーアカウント削除時の処理
**As a** システム  
**I want to** オーナーのアカウント削除時に関連ワークスペースを削除する  
**So that** 孤立したワークスペースが発生しない

**受け入れ基準:**
- WHEN オーナーがアカウントを削除する、システムはそのユーザーが所有する全てのワークスペースを自動的に削除しなければならない
- システムは削除前に影響を受けるメンバー数を表示して警告しなければならない
- システムはワークスペース削除と同じ処理（ノード、エッジ、ドキュメントの削除）を実行しなければならない
- WHEN ワークスペースが削除された、メンバーがそのワークスペースにアクセスしようとした場合、システムはホーム画面へリダイレクトし「アクセスしようとしたワークスペースは存在しません」と表示しなければならない

## 非機能要件

### パフォーマンス要件
- ワークスペース切り替えは3秒以内に完了すること
- 同時に1000個のワークスペースをサポートすること
- 各ワークスペースは最大100人のメンバーをサポートすること
- ユーザーは無制限の数のワークスペースのメンバーになれること

### セキュリティ要件
- 全ての通信はHTTPSで暗号化されること
- 招待コード（UUID）は予測不可能な値であること
- パスワードリセットトークンは1回限り使用可能であること
- メンバー削除時は該当ユーザーの次回API呼び出しで401エラーを返し、フロントエンドは401受信でホーム画面へリダイレクトすること
- 権限チェックはバックエンドで必ず実施されること

### 可用性要件
- システムは99.9%の稼働率を維持すること
- 計画的メンテナンスは月1回、2時間以内とすること

### 互換性要件
- 主要なWebブラウザの最新2バージョンをサポートすること

## 用語定義

- **ワークスペース**: 独立したプロジェクト環境。データは完全に分離される
- **オーナー**: ワークスペースの作成者。全ての権限を持つ。ユーザーは同時に1つのワークスペースのオーナーにのみなれる
- **メンバー**: ワークスペースに参加しているユーザー。権限設定により操作可能範囲が制限される
- **招待コード**: ワークスペースのUUID。これを共有することで他のユーザーを招待する
- **編集権限**: メンバーに設定される権限。読み取り専用、フル編集可能、エリア別編集制限の3種類。エリアごとの編集権限はノードの作成・削除・内容編集を包括する
- **エリア**: ParallelLeanの5つの領域（KnowledgeBase、IdeaStock、Build、Measure、Learn）